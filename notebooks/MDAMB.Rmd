---
title: "MDAMB"
author: "Lucy"
date: "2023-11-05"
output: html_document
---


## load libraries
```{r}
library(readr)
library(knitr)
library(tidyverse)
library(GEOquery)
library(limma)
library(statmod)
library(ggplot2)
library(datawizard)
library(reshape2)
library(ggplot2)
library(ggfortify)
```

```{r}
#protein data
MDAMB_raw_data <- read_tsv(file = '../data/combined_protein_reMDAMB.tsv')

#meta data
MDAMB_meta_data <- read_tsv(file = '../data/experiment_annotation_reMDAMB.tsv')

c468_meta_data <- MDAMB_meta_data[c(1:8, 13:20, 25:32), ]

c231_meta_data <- MDAMB_meta_data[c(9:12, 21:24), ]

```



```{r}
#1. remove contamination
MDAMB_remove_contam <- MDAMB_raw_data[- grep("contam_sp", MDAMB_raw_data$Protein),]

#2. remove unnecessary columns
MDAMB_shorten <- select(MDAMB_remove_contam, Protein, "Protein ID", "Entry Name", Description, contains("MaxLFQ Intensity"))
MDAMB_shorten[MDAMB_shorten == 0] <- NA

#3. log transformation

MDAMB_numeric <- MDAMB_shorten %>% select(contains("MaxLFQ Intensity"))
rownames(MDAMB_numeric) <- MDAMB_shorten$Protein
MDAMB_logged <- log2(MDAMB_numeric)
rownames(MDAMB_logged) <- MDAMB_shorten$Protein

MDAMB_logged$na_count <- rowSums(is.na(MDAMB_logged))
naid <- which(MDAMB_logged$na_count == ncol(MDAMB_logged)-1)
MDAMB_logged <- MDAMB_logged[-naid,-37] 
rownames(MDAMB_logged) <- rownames(MDAMB_numeric)[-naid]

hist(as.matrix(MDAMB_logged), breaks = 100)

# #4. data imputation
# 
# MDAMB_bpca <- pca(MDAMB_logged, method = "bpca", center = TRUE, nPcs = 5, completeObs = TRUE, scale = "vector")
# 
# MDAMB_bpca <- as.data.frame(MDAMB_bpca@completeObs)
# rownames(MDAMB_bpca) <- rownames(MDAMB_logged)

hist(as.matrix(MDAMB_bpca), breaks = 100)
```

## PCA (Without Log transform)

```{r}

data.filt.pca <- t(MDAMB_logged) %>% as.data.frame()

## replace NA with 0 because that should mean 0 spectral count
data.filt.pca[is.na(data.filt.pca)] <- 0
rownames(data.filt.pca) <- data.filt.pca[,1]
data.filt.pca <- subset(data.filt.pca, select = -c(1))

p <- prcomp(data.filt.pca, scale = TRUE)

data.filt.pca = rownames_to_column(data.filt.pca)
data.filt.pca$condition = c("control231", "control231", "control231", "control468", "control468", "control468", "control468_42hr", "control468_42hr", "control468_42hr", "drug231", "drug231", "drug231", "drug468", "drug468", "drug468", "drug468_42hr", "drug468_42hr", "drug468_42hr", "high231", "high231", "high_drug231", "high_drug231", "high231", "low468", "low468", "low468", "low468_42hr", "low468_42hr", "low468_42hr", "high_drug231", "low_drug468_42hr", "low_drug468", "low_drug468", "low_drug468", "low_drug468_42hr", "low_drug468_42hr")

autoplot(p, data=data.filt.pca, colour = "condition")

```


###quality control
```{r}
#histogram

# first, transpose data to standardize by protein
# (by default, the standardize() function will calculate z scores by column,
# so we want our proteins as columns now
data.t <- data.frame(t(MDAMB_logged))
data.t.z <- datawizard::standardize(data.t)

# Now, we need the data in long-form (melted) for making the heatmap.
# we want to bind the sample metadata to this matrix ahead of melting
# First make sure the protein data and the metadata are ordered the same
rownames(data.t.z)==MDAMB_meta_data$sample #check

# The order is not the same. Order both objects and try again
meta_data.order <- MDAMB_meta_data[order(MDAMB_meta_data$sample),]

#I am sure you could order the rownames directly too, but here I move the sample names into a column, order it, and move it back to rownames
data.t.z <- rownames_to_column(data.t.z) 
data.t.z <- data.t.z[order(data.t.z$rowname),]
rownames(data.t.z) <- NULL #uninitialize rownames to accept new names
data.t.z <- column_to_rownames(data.t.z, var = "rowname")
rownames(data.t.z) == MDAMB_meta_data$sample #Success!

#now that it's ordered, bind metadata variables to protein data
data.t.z <- data.frame(cbind(data.t.z, MDAMB_meta_data))

#define vector for id.vars
vars <- colnames(MDAMB_meta_data)
data.t.z.melt <- melt(data.t.z, id.vars = vars, value.name = "Z.score", variable.name = "Protein")
head(data.t.z.melt)

ggplot(data.t.z.melt, aes(x = sample, y = Protein, fill = Z.score)) +
  geom_tile()+
  scale_fill_gradient2(low = "#0571b0", mid = "white", high = "#ca0020",
                       name = "Z score", limits = c(-4,4),na.value = "grey")+
  theme_bw()+
  theme(axis.text.y = element_blank(),
        axis.text.x = element_text(angle = -50, hjust = 0, size = 6, color = "black"),
        plot.background = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position = "top")+
  scale_y_discrete(expand = c(0,0)) + 
  scale_x_discrete(expand = c(0,0))  

#data look uniform without major outliers

```

## Data reorganization for limma
```{r}
c468_data_logged <- MDAMB_logged[,c(4:9, 13:18, 24:29, 31:36)]
```



## Call for limma
```{r}
design <- model.matrix(~ gene*drug, data = c468_meta_data)
colnames(design) <- c("intercept", "genelow", "drugyes", "interaction")
fit <- lmFit(c468_data_logged, design)
colnames(fit)
con <- makeContrasts(interaction - genelow, levels = design)
fit.con <- contrasts.fit(fit, con)
bayes <- eBayes(fit.con)
results <- topTable(bayes, n =Inf, p.value = 0.05)

```

## Volcano plots
```{r}
## Split the Protein name by delimiter "|"
female_prots <- rownames_to_column(female_prots, "Protein") 
female_prots <- separate_wider_delim(female_prots, cols=Protein, delim = "|", names = c("first", "second", "third"))
female_prots <- separate_wider_delim(female_prots, cols = third, delim = "_", names= c("name", "human"))
female_prots <- female_prots %>% select(-c("first", "second", "human"))

# add a column of NAs
female_prots$diffexpressed <- "NO"
# if log2Foldchange > 0.6 and pvalue < 0.05, set as "UP" 
female_prots$diffexpressed[female_prots$logFC > 0 & female_prots$adj.P.Val < 0.05] <- "UP"
# if log2Foldchange < -0.6 and pvalue < 0.05, set as "DOWN"
female_prots$diffexpressed[female_prots$logFC < 0 & female_prots$adj.P.Val < 0.05] <- "DOWN"

female_prots$delabel <- NA
female_prots$delabel[female_prots$diffexpressed != "NO"] <- female_prots$name[female_prots$diffexpressed != "NO"]

# Re-plot but this time color the points with "diffexpressed"
ggplot(data=female_prots, aes(x=logFC, y=-log10(adj.P.Val), col=diffexpressed, label=delabel)) + geom_point() + theme_minimal() + geom_text_repel(size = 3, colour = "black",max.overlaps = 30) +
         scale_color_manual(values=c("pink", "gray", "plum3")) +
        geom_vline(xintercept=0, col="gray20") +
        geom_hline(yintercept=-log10(0.05), col="gray20")
```

