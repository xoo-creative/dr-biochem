---
title: "astrocytes_malevsfemale_DIA"
author: "Lucy"
date: "2024-05-02"
output: html_document
---

```{r}
library(readr)
library(knitr)
library(tidyverse)
```

### import data

```{r}
#protein data
astro_rawdata <- read_tsv(file='../data/20240226_primary_astrocytes_malevsfemale_bulk_original_TT.tsv')

#meta data
astro_metadata <- read_tsv(file = '../data/20240226_primary_astrocytes_malevsfemale_bulk_TT_metadata.tsv')
```

### pre-process/cleaning data:

```{r}
#1. remove contamination
rawdata_wo_contam <- astro_rawdata[- grep("CONT", astro_rawdata$Protein.Group),]

#2. Remove the "_HUMAN" off the Protein Names
rawdata_wo_contam$Protein.Names <- gsub("_HUMAN", "", rawdata_wo_contam$Protein.Names)

#3. log transformation

astro_dat <- column_to_rownames(rawdata_wo_contam, var = "Protein.Names")
proteins <- rownames(astro_dat)
astro_protein_descriptions <- data.frame(cbind("Description" = astro_dat$First.Protein.Description, proteins))
astro_dat_numeric <- select(astro_dat, -c(First.Protein.Description, Protein.Ids, Protein.Group, Genes))
astro_dat <- log2(astro_dat_numeric)

#4. filter
#make a new column counting the number of "NA" values
count <- rowSums(is.na(astro_dat))
astro_dat <- data.frame(cbind(astro_dat, "Count" = count))

#Adjust the threshold at your discretion. 
#Here, I am allowing up to 2 protein observations to be "NA"
astro_dat <- subset(astro_dat, Count < 2)
astro_dat <- subset(astro_dat, select = -c(Count)) #Remove count variable

#5. imputation
library(pcaMethods)

datafilt <- pca(astro_dat, method = "bpca", center = TRUE, nPcs = 5, completeObs = TRUE, scale = "vector")
datafilt <- as.data.frame(datafilt@completeObs)
rownames(datafilt) <- rownames(astro_dat)
hist(as.matrix(datafilt), breaks = 100)
length(datafilt[datafilt <= 7])

#write.csv(datafilt, file = "20240509_astrocyte_LucyChi.csv")
```

### quality control

```{r}

#histogram
 heatmap(
   as.matrix(datafilt), 
   Rowv=as.dendrogram(hclust(dist(as.matrix(datafilt)))),
   Colv=as.dendrogram(hclust(dist(t(as.matrix(datafilt))))))
 
```

### PCA

```{r}
library(ggplot2)
library(ggfortify)
data_filt_pca <- t(datafilt) %>% as.data.frame()

## replace NA with 0
data_filt_pca[is.na(data_filt_pca)] <- 0

p <- prcomp(data_filt_pca, scale = TRUE)

data_filt_pca = rownames_to_column(data_filt_pca)
data_filt_pca$condition = c("F", "F", "F", "F", "F", "F", "M", "M", "M", "M", "M", "M")

autoplot(p, data=data_filt_pca, colour = "condition", frame = TRUE, frame.type = 'norm')
```

```{r}
#check for metadata order
astro_names <- colnames(datafilt)
colnames(datafilt) <- astro_names
colnames(datafilt) == astro_metadata$file #if false - order them

#if the order is incorrect
# datafilt <- datafilt[,order(names(datafilt))]
# astro_metadata <- astro_metadata[order(astro_metadata$file),]
# #Check again
# colnames(datafilt) == astro_metadata$file #TRUE!

```

### limma

```{r}
library(limma)
desMat <- model.matrix(~condition, astro_metadata)

#Call limma
fit <- lmFit(datafilt, desMat)
contrast <- makeContrasts("conditionmale", levels = desMat)
colnames(fit)
fit.con <- contrasts.fit(fit, contrast)
tmp <- eBayes(fit.con)
astro_prots <- topTable(tmp, n = Inf)
astro_sigprots <- astro_prots[which(astro_prots$adj.P.Val <= 0.05 & abs(astro_prots$logFC) >= 1),]
sigprots <- astro_prots[which(astro_prots$adj.P.Val <= 0.05),]
sigprots <- rownames_to_column(sigprots, var = "ID")
prots <- rownames_to_column(astro_prots, var = "ID")
male_sigprots <- filter(sigprots, logFC > 0)
female_sigprots <- filter(sigprots, logFC < 0)
astro_sigprots_names <- rownames_to_column(astro_sigprots, var = "ID")

#write_tsv(astro_sigprots_names, file = "20240226_astro_sigprots.tsv")
#write_tsv(male_sigprots, file = "20240226_male_sigprots.tsv")
#write_tsv(female_sigprots, file = "20240226_female_sigprots.tsv")

#glimmaMA(tmp)

```

### Volcano plots

```{r}
library(ggrepel)


#BiocManager::install("EnhancedVolcano")
library("EnhancedVolcano")


keyvals <- ifelse(astro_prots$logFC < -1, '#FF595E', ifelse(astro_prots$logFC > 1, '#1982C4', 'grey50'))
keyvals[is.na(keyvals)] <- 'grey50'
names(keyvals)[keyvals == '#FF595E'] <- 'female'
names(keyvals)[keyvals == 'grey50'] <- 'NS'
names(keyvals)[keyvals == '#1982C4'] <- 'male'

#volcano with selected protein labels
EnhancedVolcano(astro_prots,
    lab = rownames(astro_prots),
    x = 'logFC',
    y = 'adj.P.Val',
    selectLab = c('DDX3Y','DRB5', 'IL33', 'IL18', 'IL1AP', '	
DRB1', 'DRA'),
    xlab = bquote(~Log[2]~ 'fold change'),
    title = 'astrocyte - significant proteins',
    subtitle = '',
    pCutoff = 0.05,
    FCcutoff = 1.0,
    pointSize = 2.0,
    labSize = 4.0,
    col=c('gray10', 'gray50', 'gray20', 'red3'),
    labCol = 'black',
    labFace = 'bold',
    boxedLabels = TRUE,
    colAlpha = 4/5,
    legendPosition = 'right',
    legendLabSize = 10,
    legendIconSize = 4.0,
    drawConnectors = TRUE,
    widthConnectors = 1.0,
    colConnectors = 'black',
    colCustom = keyvals)


#volcano for all significant proteins labeled
EnhancedVolcano(astro_prots, lab = rownames(astro_prots), 
                x = 'logFC', 
                y = 'adj.P.Val', 
                selectLab = rownames(astro_prots)[which(names(keyvals) %in% c('female', 'male'))], 
                xlab = bquote(~log[2]~ 'fold change'), 
                ylab = "-log10(adj.P)",
                title = 'astrocyte male vs female', 
                pCutoff = 0.05, 
                subtitle = ' ', 
                FCcutoff = 1, 
                pointSize = 3.0, 
                labSize = 4, 
                shape = c(16, 16, 16, 16), 
                colCustom = keyvals, 
                colAlpha = 1, 
                legendPosition = 'right', 
                legendLabSize = 10, 
                legendIconSize = 4.0, 
                drawConnectors = TRUE, 
                widthConnectors = 0.75, 
                gridlines.major = FALSE, 
                gridlines.minor = FALSE, 
                border = 'partial', 
                borderWidth = 1.5, 
                borderColour = 'black')
```

### heatmaps

```{r}
hitList <- rownames(astro_sigprots)
datMat <- datafilt[rownames(datafilt) %in% hitList, ] 

#Create a color bar to distinguish sample groups
datMat <- datMat[,order(names(datMat))]

library(RColorBrewer)
my_group <- data.frame(cbind("Group" = astro_metadata$condition, "File" = astro_metadata$file))
my_group <- column_to_rownames(my_group, var = "File")

rownames(my_group) <- colnames(datMat)

annoCol1<-list(Group=c(female="#FF595E",male="#1982C4"))

library(pheatmap)
pheatmap(
  as.matrix(datafilt), scale="row", annotation_col = my_group,
  width = 5, height = 8,
  color=colorRampPalette(c("#9A54AA", "white", "#FF9F1C"))(50),
  annotation_colors = annoCol1,
  show_rownames = FALSE, show_colnames = FALSE,
  Rowv=as.dendrogram(hclust(dist(as.matrix(datafilt)))),
  Colv=as.dendrogram(hclust(dist(t(as.matrix(datafilt))))))

```

```{r}
library(msigdbr)
#load immune database
IMMUNE.human.db <- msigdbr(species = "human", 
                           category = "C7", 
                           subcategory = "IMMUNESIGDB")

immune_proteins <- filter(heatmap_dat, protein  %in% IMMUNE.human.db$human_gene_symbol)

# immune_lol <- IMMUNE.human.db %>% 
#   dplyr :: select(gene_symbol, gs_name) 
# # %>% 
#   make.gs.lol()
# 
# #Gene set enrichment analysis with fgsea(). 
# IMMUNE.fgsea <- fgsea::fgsea(pathways = immune_lol, stats = deg.ranks, scoreType = "pos")
# 
# #Show top 5 genes for each pathway:
# # Here, we are "pasting" the first five genes in the leadingEdge column
# IMMUNE.fgsea[,
#            topGenes := paste0(head(unlist(`leadingEdge`), 5), collapse=", "),
#            by = .(pathway)]
# 
# #Show result in table. 
# IMMUNE.fgsea %>%
#     arrange(pval) %>%
#     head(10) %>% 
#     dplyr::select(-leadingEdge) %>% 
#     knitr::kable()
# 
# # filter significant pathways. Set p<0.05. 
# IMMUNE_significant_pathways <- IMMUNE.fgsea[padj < 0.05]
# IMMUNE_significant_pathways
```

```{r}
#heatmap breakdown

## significant proteins
pheatmap(
  as.matrix(datMat), scale="row", annotation_col = my_group,
  width = 5, height = 8,
  color=colorRampPalette(c("#9A54AA", "white", "#FF9F1C"))(50),
  annotation_colors = annoCol1,
  show_rownames = FALSE, show_colnames = FALSE,
  Rowv=as.dendrogram(hclust(dist(as.matrix(datMat)))),
  Colv=as.dendrogram(hclust(dist(t(as.matrix(datMat))))))

## immune proteins

heatmap_dat <- rownames_to_column(datafilt, var = "protein")
heatmap_innate <- filter(heatmap_dat, protein  %in% c('IRAK1', 'IRAK4', 'TAB1', 'TAB2', 'TAB3', 'TRAF6', 'NFKB1', 'NFKB2', 'ISG15', 'JAK1', 'JAK2', 'IFI44', 'IFIT1', 'IFIT3', 'IFIT5', 'IKKB', 'JUN', 'STAT1', 'STAT2', 'STAT3', 'STAT6', "IRF2", "IRF3", "IRF9", "TLR3", 'IRF2BP1', 'IRF2BP2', 'IRF2BPL'))

heatmap_innate <- column_to_rownames(heatmap_innate, var = "protein")

pheatmap(
  as.matrix(heatmap_innate), scale="row", annotation_col = my_group,
  width = 5, height = 8,
  color=colorRampPalette(c("#9A54AA", "white", "#FF9F1C"))(50),
  annotation_colors = annoCol1,
  show_rownames = TRUE, show_colnames = FALSE,
  Rowv=as.dendrogram(hclust(dist(as.matrix(heatmap_immune)))),
  Colv=as.dendrogram(hclust(dist(t(as.matrix(heatmap_immune))))))
```

```{r}
heatmap_immune <- filter(heatmap_dat, protein  %in% c( 'IL33', 'IL18', 'IL9', 'ILF2', 'ILF3', 'ILEU', 'DRB5', 'DRB1', 'DRB3', 'CXCL4', 'CXCL8', 'CXCR4'))

heatmap_immune <- column_to_rownames(heatmap_immune, var = "protein")

pheatmap(
  as.matrix(heatmap_immune), scale="row", annotation_col = my_group,
  width = 5, height = 8,
  color=colorRampPalette(c("#9A54AA", "white", "#FF9F1C"))(50),
  annotation_colors = annoCol1,
  show_rownames = TRUE, show_colnames = FALSE,
  Rowv=as.dendrogram(hclust(dist(as.matrix(heatmap_immune)))),
  Colv=as.dendrogram(hclust(dist(t(as.matrix(heatmap_immune))))))
```

### barplots

```{r}
# top10 proteins
hitList <- rownames(astro_sigprots)
topTen <- hitList[1:10]
topTenPlots <- subset(datafilt, rownames(datafilt) %in% topTen)
topTenPlots.t <- data.frame(t(topTenPlots))
topTenPlots.t <- topTenPlots.t[order(row.names(topTenPlots.t)), ]
topTenPlots.t <- cbind(topTenPlots.t, "Group" = astro_metadata$condition, "File" = astro_metadata$file)
rownames(topTenPlots.t) <- NULL 
topTenPlots.t <- column_to_rownames(topTenPlots.t, var = "File")
library(reshape2)
topTenPlots.long <- melt(topTenPlots.t, id.vars = "Group")

ggplot(topTenPlots.long, aes(x = Group, y = value, fill = Group)) +
  geom_boxplot(outlier.shape = NA, lwd = .5, show.legend = TRUE)+
  geom_point(position = position_jitterdodge(jitter.width = .3,
                                             dodge.width = .75), 
             size = .5, alpha = 0.5, 
             show.legend = TRUE) +
  scale_y_continuous(name = "Protein abundance\n(log2(LFQ intensity))") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        # panel.grid.minor = element_blank(),
        # panel.border = element_blank(),
        # panel.background = element_blank(),
        axis.title.y = element_text(size = 10),
        axis.title.x = element_text(size = 10),
        axis.text.y = element_text(colour="black", size = 10),
        axis.text.x = element_text(colour="black", size = 10),
        axis.line = element_line(size=0.5, colour = "black")) +
 # scale_fill_brewer(palette = "Paired")+
      scale_fill_manual(values=c("#FF595E", "#1982C4"))+
  scale_color_manual(values=c("#FF595E", "#1982C4"))+
  theme(plot.margin = margin(0,1,0,0, "cm"))+
  theme(axis.text.x = element_text(angle = -50, hjust = 0))+
  facet_wrap(~variable)



```

```{r}
library(reshape2)
library(ggsignif)

# sex-based proteins

sexprot <- c("CRF", "DDX3Y", "DDX3X", "ZFX;ZFY")
sexPlots <- subset(datafilt, rownames(datafilt) %in% sexprot)
sexPlots.t <- data.frame(t(sexPlots))
sexPlots.t <- sexPlots.t[order(row.names(sexPlots.t)), ]
sexPlots.t <- cbind(sexPlots.t, "Group" = astro_metadata$condition, "File" = astro_metadata$file)
rownames(sexPlots.t) <- NULL 
sexPlots.t <- column_to_rownames(sexPlots.t, var = "File")
sexPlots.long <- melt(sexPlots.t, id.vars = "Group")


p_values <- data.frame(
  variable = c("DDX3X", "DDX3Y", "CRF", "ZFX.ZFY"),
  annotation = c("adj.p = 0.018", "adj.p = 0.00016", "adj.p = 0.95e-13", "adj.p = 0.0074"),
  y_position = c(19, 19, 19, 19)  # Adjust these based on your scale
)


ggplot(sexPlots.long, aes(x = Group, y = value, fill = Group, color=Group)) +
  geom_boxplot(outlier.shape = NA, lwd = .5, show.legend = TRUE)+
  geom_point(position = position_jitterdodge(jitter.width = .3,
                                             dodge.width = .75), 
             size = .5, alpha = 1, 
             show.legend = TRUE) +
  theme_bw() +
   theme(panel.grid.major = element_blank(),
  #       panel.grid.minor = element_blank(),
  #       panel.border = element_blank(),
  #       panel.background = element_blank(),
  #       axis.title.y = element_text(size = 10),
  #       axis.title.x = element_text(size = 10),
         axis.text.y = element_text(colour="black", size = 10),
         axis.text.x = element_text(colour="black", size = 10),
         axis.line = element_line(size=0.5, colour = "black")) +
  # scale_fill_brewer(palette = "Paired")+
    scale_fill_manual(values=c("#FF595E", "#1982C4"))+
  scale_color_manual(values=c("#FF595E", "#1982C4"))+
   theme(plot.margin = margin(0,1,0,0, "cm"))+
   theme(axis.text.x = element_text(angle = -50, hjust = 0))+
   facet_wrap(~variable) +
  geom_signif(data = p_values, aes(xmin = 1, xmax = 2,annotations = annotation, y_position = y_position), 
              manual = TRUE, inherit.aes = FALSE, 
              tip_length = 0.02, textsize = 3, vjust = -0.5) + ylim(5, 22)

```

### GSEA

```{r}
library("UniprotR")
astro_sigprots_pos <- astro_sigprots %>% filter(logFC > 0)
astro_sigprots_neg <- astro_sigprots %>% filter(logFC < 0)

gsea_dat_pos <- rownames_to_column(astro_sigprots_pos, var = "Protein.Names")
gsea_dat_neg <- rownames_to_column(astro_sigprots_neg, var = "Protein.Names")


## https://github.com/Proteomicslab57357/UniprotR


Accessions <-GetAccessionList("https://s3.amazonaws.com/csvpastebin/uploads/9571fa356c67a0c7c95e8431799a051a/Accessions.csv") 

gsea_final_pos <- left_join(gsea_dat_pos, rawdata_wo_contam, by = "Protein.Names") %>% select(colnames(gsea_dat_pos), "Protein.Ids")

gsea_final_neg <- left_join(gsea_dat_neg, rawdata_wo_contam, by = "Protein.Names") %>% select(colnames(gsea_dat_neg), "Protein.Ids")

GeneOntologyObj_m <- GetProteinGOInfo(gsea_final_pos$Protein.Ids) 
#Plot Biological process information top 10 go terms  
PlotGOBiological(GeneOntologyObj_m) 

GeneOntologyObj_f <- GetProteinGOInfo(gsea_final_neg$Protein.Ids) 
#Plot Biological process information top 10 go terms  
PlotGOBiological(GeneOntologyObj_f) 


# #Plot molecular function information top 20 go terms
# Plot.GOMolecular(GeneOntologyObj, Top = 20)
# #Plot subcellualr localization information 
# Plot.GOSubCellular(GeneOntologyObj) 
# #Combine Gene ontology plots into one plot 
# PlotGoInfo(GeneOntologyObj)


# GETSeqFastaUniprot(Accessions = gsea_final_pos[1:20,]$Protein.Ids, FileName = "Acclist")

Enrichment.REAC(gsea_final_pos$Protein.Ids, top = 20)
Enrichment.REAC(gsea_final_neg$Protein.Ids, top = 20)

Pathway.Enr(gsea_final_pos$Protein.Ids)
Pathway.Enr(gsea_final_neg$Protein.Ids)


pathology_obj <- GetPathology_Biotech(gsea_final_neg[1:20,]$Protein.Ids)
diseases <- Get.diseases(pathology_obj)           
diseases
                                   


```

```{r}
#https://biit.cs.ut.ee/gprofiler/gost
library(GOplot)
astro_go <- read_tsv(file='../data/astrocyte_brain_gene_annotation.tsv')
astro_gprofiler_m <- read_csv(file='../data/20240226_male_gProfiler_hsapiens_5-11-2024_6-39-03 PM__intersections.csv')
astro_gprofiler_f <- read_csv(file='../data/20240226_female_gProfiler_hsapiens_5-11-2024_6-05-04 PM__intersections.csv')
astro_sig_gprofiler <- read_csv(file='../data/20240226_gprofiler_sig.csv')
astro_gprofiler <- read_csv(file='../data/20240226_complete_gprofiler_hsapiens.csv')



#GO analysis for female
female_sigprots <- rownames_to_column(female_sigprots, var = "ID")
female_go <- filter(female_sigprots, gene  %in% astro_go$gene) 

female_go <- merge(female_go, astro_go, by = "gene")

#GO analysis for male
male_sigprots <- rownames_to_column(male_sigprots, var = "ID")
male_go <- filter(male_sigprots, ID  %in% astro_go$gene) 

#male_go <- merge(male_go, astro_go, by = "ID")

# astro_circ_m <- circle_dat(astro_gprofiler_m, male_sigprots)
# astro_circ_sig_m <- filter(astro_circ_m, adj_pval < 0.05)
# astro_circ_top10 <- top_n(astro_circ_sig_m, 10, adj_pval)
```

### GOPlots

Key notes:

-   GOHeat needs unique lists of `gene` and `processes`

-   GOBubble automatically filters to keep ONLY those with `-log(adj_pval)` \>= 5 (or what they call `labels=5`) which is equivalent to `adj_pval <= 0.00001`. To override this, you have to pass in your own threshold. Try `labels=1` to start with.

-   GOBar needs heavy data filtering before using, or else all the bars will be buried away into tiny lines.

You will see all of those in action here below:

#### Set up

We need `gprofiler` and the `astro_sigprots`

```{r}
astro_sig_gprofiler <- read_csv(file='../data/20240226_gprofiler_sig.csv')
astro_gprofiler <- read_csv(file='../data/20240226_complete_gprofiler_hsapiens.csv')
astro_sigprots_names <- rownames_to_column(astro_sigprots, var = "ID")
```

#### GOBar

```{r}
astro_circ <- circle_dat(astro_gprofiler, sigprots)
astro_circ_f <- circle_dat(astro_gprofiler_f, female_sigprots)

## Filtering those with `adj_pval` == 1, cause it's noise that clogs up the plot
astro_circ <- subset(astro_circ, adj_pval < 0.00001)
astro_circ_f <- subset(astro_circ_f, adj_pval < 0.005)
```

```{r}
GOBar(subset(astro_circ, category == 'GO:BP'))
```

#### GOBubble

```{r}
## Use a low value for `labels` or else all your data will be filtered out and you may get
##     a weird error about "dimensions 0;1"

GOBubble(astro_circ, labels = 1)
```

#### GOHeat

```{r}
## Need to use the **unique** lists of genes and processes. The `chord_dat` function will connect those back together for you.

##  See the EC$genes and EC$processes as the example since they are both unique.
##      chord <- chord_dat(circ, EC$genes, EC$process)

chord <- chord_dat(astro_circ, unique(astro_circ$genes), unique(astro_circ$term))
chord_f <- chord_dat(astro_circ_f, unique(astro_circ_f$genes), unique(astro_circ_f$term))

GOHeat(chord_f, nlfc = 0) # 0 for plotting counts
GOHeat(chord, nlfc = 1) # 1 for plotting logFC
```
