---
title: "astrocytes_malevsfemale"
author: "Lucy"
date: "2023-12-04"
output: html_document
---

---
title: "229E_astro_Infection_differential_expression"
author: "Lucy"
date: "2023-10-01"
output: html_document
---


### Load librarys
```{r}
# install.packages("datawizard")
library(readr)
library(knitr)
library(tidyverse)
library(GEOquery)
library(limma)
library(statmod)
library(ggplot2)
library(datawizard)
library(reshape2)
library(ggplot2)
library(ggfortify)
library(pcaMethods)
```

###import data
```{r}
#protein data
astro_raw_data <- read_tsv(file = '../data/combined_protein_astrocytes_sex_time.tsv')

nrow(astro_raw_data)
#meta data
astro_meta_data <- read_tsv(file = '../data/experiment_annotation_astrocytes_sex_time.tsv')

astro_meta_data$sex <- c("F", "F", "F", "F", "F", "F", "M", "M", "M", "M", "M", "M")
astro_meta_data$time <- c("T33", "T33", "T33", "T37", "T37", "T37", "T33", "T33", "T33", "T37", "T37", "T37")
female_meta_data <- astro_meta_data[1:6, ]
male_meta_data <- astro_meta_data[7:12, ]
astro_meta <- astro_meta_data[c(4:6, 10:12), ]
```

###pre-process/cleaning data:
####1. remove contamination
####2. remove unnecessary columns
####3. log transformation if required
####4. remove lowly expressed proteins
```{r}
#1. remove contamination
raw_data_wo_contam <- astro_raw_data[- grep("contam_sp", astro_raw_data$Protein),]

#2. remove unnecessary columns
data_shorten <- select(raw_data_wo_contam, Protein, "Protein ID", "Entry Name", Description, contains("MaxLFQ Intensity"))
data_shorten[data_shorten == 0] <- NA

#3. log transformation

numeric_MaxLFQ_data <- data_shorten %>% select(contains("MaxLFQ Intensity"))
rownames(numeric_MaxLFQ_data) <- data_shorten$Protein
logged_data <- log2(numeric_MaxLFQ_data)
rownames(logged_data) <- data_shorten$Protein

#re-organiza data for future analysis

#female only
female_logged_data <- logged_data[ , 1:6]
female_logged_data$Description = data_shorten$Description
#male only
male_logged_data <- logged_data[ , 7:12]
rownames(male_logged_data) <- data_shorten$Protein
#both sex incubated at 37C only
astro_data <- logged_data[ , c(4:6, 10:12)]
rownames(astro_data) <- data_shorten$Protein
#pre-imputation data
hist(as.matrix(astro_data), breaks = 100)

#4. imputation
astro_data$na_count <- rowSums(is.na(astro_data))
naid <- which(astro_data$na_count == ncol(astro_data)-1)
astro_data <- astro_data[-naid,-7] 
rownames(astro_data) <- rownames(data_shorten)[-naid]
astro_data_bpca <- pca(astro_data, method = "bpca", center = TRUE, nPcs = 5, completeObs = TRUE, scale = "vector")
astro_data_bpca <- as.data.frame(astro_data_bpca@completeObs)
rownames(astro_data_bpca) <- rownames(astro_data)
hist(as.matrix(astro_data_bpca), breaks = 100)

#no data imputation

# #4. remove lowly expressed proteins
# #convert "-inf" to "NA"
# infec_data_logged[infec_data_logged == "-Inf"] <- NA
# 
# #make a new column counting the number of "NA" values
# count <- rowSums(is.na(infec_data_logged))
# data.log.filt <- data.frame(cbind(infec_data_logged, "Count" = count))
# 
# #Adjust the threshold at your discretion. 
# #Here, I am allowing up to 75% of protein observations to be "NA"
# data.log.filt <- subset(data.log.filt, Count < ncol(infec_data_logged)*0.75)
# data.log.filt <- subset(data.log.filt, select = -c(Count)) #Remove count variable
```

## PCA(Without Log transform))

```{r}
count <- rowSums(is.na(numeric_MaxLFQ_data))
data.filt <- data.frame(cbind(numeric_MaxLFQ_data, "Count" = count))

data.filt <- subset(data.filt, Count < ncol(numeric_MaxLFQ_data)*0.75)
data.filt <- subset(data.filt, select = -c(Count))

data.filt.pca <- t(data.filt) %>% as.data.frame()

## replace NA with 0 because that should mean 0 spectral count
data.filt.pca[is.na(data.filt.pca)] <- 0

## A way you can check which column has all the same values (if any)
# which(apply(data.filt.pca, 2, var)==0)

# data.filt.pca = data.filt.pca %>% select(-c(rowname))

data.filt.pca %>% head()

p <- prcomp(data.filt.pca, scale = TRUE)

data.filt.pca = rownames_to_column(data.filt.pca)
#data.filt.pca$condition = c("F1_33C", "F2_33C", "F3_33C", "F1_37C", "F2_37C", "F3_37C", "M1_33C", "M2_33C", "M3_33C", "M1_37C", "M2_37C", "M3_37C")
data.filt.pca$condition = c("F", "F", "F", "F", "F", "F", "M", "M", "M", "M", "M", "M")

autoplot(p, data=data.filt.pca, colour = "condition")

```


###quality control
```{r}
#histogram

# first, transpose data to standardize by protein
# (by default, the standardize() function will calculate z scores by column,
# so we want our proteins as columns now
data.t <- data.frame(t(data.filt))
data.t.z <- standardize(data.t)

# Now, we need the data in long-form (melted) for making the heatmap.
# we want to bind the sample metadata to this matrix ahead of melting
# First make sure the protein data and the metadata are ordered the same
rownames(data.t.z)==astro_meta_data$sample #check

# The order is not the same. Order both objects and try again
meta_data.order <- astro_meta_data[order(astro_meta_data$sample),]

#I am sure you could order the rownames directly too, but here I move the sample names into a column, order it, and move it back to rownames
data.t.z <- rownames_to_column(data.t.z) 
data.t.z <- data.t.z[order(data.t.z$rowname),]
rownames(data.t.z) <- NULL #uninitialize rownames to accept new names
data.t.z <- column_to_rownames(data.t.z, var = "rowname")
rownames(data.t.z) == astro_meta_data$sample #Success!

#now that it's ordered, bind metadata variables to protein data
data.t.z <- data.frame(cbind(data.t.z, astro_meta_data))

#define vector for id.vars
vars <- colnames(astro_meta_data)
data.t.z.melt <- melt(data.t.z, id.vars = vars, value.name = "Z.score", variable.name = "Protein")
head(data.t.z.melt)

ggplot(data.t.z.melt, aes(x = sample, y = Protein, fill = Z.score)) +
  geom_tile()+
  scale_fill_gradient2(low = "#0571b0", mid = "white", high = "#ca0020",
                       name = "Z score", limits = c(-4,4),na.value = "grey")+
  theme_bw()+
  theme(axis.text.y = element_blank(),
        axis.text.x = element_text(angle = -50, hjust = 0, size = 6, color = "black"),
        plot.background = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position = "top")+
  scale_y_discrete(expand = c(0,0)) + 
  scale_x_discrete(expand = c(0,0))  

#male_37_1 looks like an outlier

```

```{r}
# # check for data quality with scattered plots
# 
# histogram_log_data_sample <- data.log.filt %>%  select("X215_LucyC_6hpi1_100ng_1.Total.Intensity")
# 
# histogram_log_data_sample %>% head()
# 
# ggplot(histogram_log_data_sample, aes(x=X215_LucyC_6hpi1_100ng_1.Total.Intensity)) + geom_histogram()
# 
# histogram_log_data <- data.frame(t(data.log.filt)) %>%  select(0:1)
# 
# head(histogram_log_data)
# 
# ggplot(histogram_log_data, aes(x=sp.A0A0B4J2D5.GAL3B_HUMAN)) + geom_histogram()
# 
# library(GGally)
# 
# 
# data.filt
# ggpairs(data.log.filt, columns = c(1, 4, 6))
# ggpairs(data.log.filt, columns = c(4, 5, 6))

```

###limma differential analysis
```{r}
# colnames(data.filt) == meta_data.order$sample #if false, order them
#colnames(data.log.filt) == astro_meta_data$sample #if false, order them


#Call limma - male astrocytes at 33C and 37C
male_desMat <- model.matrix(~ time, male_meta_data)

male_fit <- lmFit(male_logged_data, male_desMat)
colnames(male_fit)

male_tmp <- eBayes(male_fit)

male_sig.prots <- topTable(male_tmp, coef = "timeT37", n = Inf, p.value = 0.05)
#male_sig.prots <- subset(limma.results, adj.P.Val < 0.05)
head(male_sig.prots)


#Call limma - female astrocytes at 33C and 37C
female_desMat <- model.matrix(~ time, female_meta_data)

female_fit <- lmFit(female_logged_data, female_desMat)
colnames(female_fit)

female_tmp <- eBayes(female_fit)

female_sig.prots <- topTable(female_tmp, coef = "timeT37", n = Inf, p.value = 0.05)
#female_sig.prots <- subset(limma.results, adj.P.Val < 0.05)
head(female_sig.prots)

#Call limma - astrocytes for male and female
astro_desMat <- model.matrix(~ sex, astro_meta)

astro_fit <- lmFit(astro_data, astro_desMat)
colnames(astro_fit)

astro_tmp <- eBayes(astro_fit)

astro_sig.prots <- topTable(astro_tmp, coef = "sexM", n = Inf, p.value = 0.01)
astro_prots <- topTable(astro_tmp, coef = "sexM", n = Inf)

```


```{r}
# The significantly differentially expressed genes are the ones found in the upper-left and upper-right corners.
# Add a column to the data frame to specify if they are UP- or DOWN- regulated (log2FoldChange respectively positive or negative)


## Split the Protein name by delimiter "|"
astro_prots <- rownames_to_column(astro_prots, "Protein") 
astro_prots <- separate_wider_delim(astro_prots, cols=Protein, delim = "|", names = c("first", "second", "third"))
astro_prots <- separate_wider_delim(astro_prots, cols = third, delim = "_", names= c("name", "human"))
astro_prots <- astro_prots %>% select(-c("first", "second", "human"))

# add a column of NAs
astro_prots$diffexpressed <- "NO"
# if log2Foldchange > 0.6 and pvalue < 0.05, set as "UP" 
astro_prots$diffexpressed[astro_prots$logFC > 0 & astro_prots$adj.P.Val < 0.01] <- "UP"
# if log2Foldchange < -0.6 and pvalue < 0.05, set as "DOWN"
astro_prots$diffexpressed[astro_prots$logFC < 0 & astro_prots$adj.P.Val < 0.01] <- "DOWN"

astro_prots$delabel <- NA
astro_prots$delabel[astro_prots$diffexpressed != "NO"] <- astro_prots$name[astro_prots$diffexpressed != "NO"]

# Re-plot but this time color the points with "diffexpressed"
library(ggrepel)
ggplot(data=astro_prots, aes(x=logFC, y=-log10(adj.P.Val), col=diffexpressed, label=delabel)) + geom_point() + theme_minimal() + geom_text_repel(size = 3, colour = "black",max.overlaps = 20) +
         scale_color_manual(values=c("pink", "gray", "plum3")) +
        geom_vline(xintercept=0, col="gray20") +
        geom_hline(yintercept=-log10(0.01), col="gray20")

###GFAP PROTEIN IS DOWNREGULATED IN MALES


```

```{r}
knitr::kable(msigdbr::msigdbr_species())

#Access the KEGG gene sets. 
kegg.human.db <- msigdbr::msigdbr(species = "human",
                                  category = "C2",
                                  subcategory = "CP:KEGG")
IMMUNE.human.db <- msigdbr(species = "human", 
                           category = "C7", 
                           subcategory = "IMMUNESIGDB")
```

```{r}
# obtain GWAS catalog information

run.if.needed <- function(.file, .code) {
    if(!file.exists(.file)) { .code }
    stopifnot(file.exists(.file))
}

gwas.tidy.file <- "gwas_catalog_tidy.tsv.gz"

run.if.needed(gwas.tidy.file, {
    gwas.file <- "gwas_catalog_v1.0-associations_e105_r2022-02-02.tsv.gz"
    run.if.needed(gwas.file, {
        url <- "https://www.ebi.ac.uk/gwas/api/search/downloads/full"
        .file <- str_remove(gwas.file, ".gz$")
        download.file(url, destfile = .file)
        gzip(.file)
        unlink(.file)
    })
    .dt <-
        fread(gwas.file, sep="\t", quote="") %>%
        dplyr::select(`MAPPED_GENE`, `DISEASE/TRAIT`, `PVALUE_MLOG`)
    .dt <- .dt[order(.dt$PVALUE_MLOG, decreasing = TRUE),
               head(.SD, 1),
               by = .(`MAPPED_GENE`, `DISEASE/TRAIT`)]
    .count <- .dt[, .(.N), by = .(`DISEASE/TRAIT`)]
    .dt <- left_join(.count[`N` >= 100, ], .dt)[nchar(`MAPPED_GENE`)> 0,]
    .dt <- .dt[,
               .(gene_symbol = unlist(strsplit(`MAPPED_GENE`, split="[ ,.-]+"))),
               by = .(`DISEASE/TRAIT`, PVALUE_MLOG)]
    .dt[, p.value := 10^(-PVALUE_MLOG)]

    fwrite(.dt, file=gwas.tidy.file)
})
```

