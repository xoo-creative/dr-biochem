---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code.

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*.

```{r}
plot(cars)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

```{r}
install.packages('ggrepel')
```

```{r}
library(dplyr)
library(ggplot2)
library(ggrepel)
```

### Load files

```{r}
control_filename = "control2.tsv"
treatment_filename = "24hpii.tsv"

baseline <- read_tsv(paste0("Data/", control_filename))
treatment <- read_tsv(paste0("Data/", treatment_filename))

print(paste0("Control has ", nrow(baseline), " rows;"))
print(paste0("Treatment has ", nrow(treatment), " rows"))
```

### Remove contamination

```{r}
baseline_clean <- baseline |> filter(!str_detect(Protein, "^contam")) |> 
                                filter(`Protein Description` != "polyprotein") |> 
                                    select(Protein, "Protein ID", "Total Spectral Count")

head(baseline_clean)
print(paste("There are", nrow(baseline_clean), "rows in control data after removing contamination"))


treatment_clean <- treatment |> filter(!str_detect(Protein, "^contam")) |> 
                                filter(`Protein Description` != "polyprotein") |> 
                                    select(Protein, "Protein ID", "Total Spectral Count")

head(treatment_clean)
print(paste("There are", nrow(treatment_clean), "rows in treatment data after removing contamination"))
```

### Log Fold Change - x-axis

```{r}
combined <- full_join(baseline_clean, treatment_clean, by= c("Protein", "Protein ID")) |> 
                rename("Control" = "Total Spectral Count.x", "Treatment" = "Total Spectral Count.y")


combined[is.na(combined)] <- 0
ratio <- combined$Treatment/combined$Control
LFC <- log2(ratio)

combined$LogFC <- LFC
head(combined)

write_csv(combined, paste0("combined", ".csv"))
```

### adjusted P value - y-axis

```{r}
#-log10(p-value)

lm_res <- limma_gen(combined, model.str = "~ Treatment", coef.str = "Treatment")
head(arrange(lm_res, adj.P.Val))

#t <- (combined$Control-combined$Treatment)/(s/sqrt(nrow(combined)-1))
#p <- 2*pt(-abs(t),df=nrow(combined)-1-1)
```

### Volcano plot

```{r}
combined$diffexpressed <- "NO"
head(combined)

#combined$diffexpressed[combined$LogFC>0.5 & combined$adj-P<0.01] <- "UP"
#combined$diffexpressed[combined$LogFC<0.5 & combined$adj-P<0.01] <- "DOWN"
```

```{r}
install.packages("protti", dependencies = TRUE)
```

```{r}
install.packages("devtools")
devtools::install_github("jpquast/protti", dependencies = TRUE)
```

```{r}
library(protti)
library(dplyr)
library(magrittr)
```

```{r}
data <- read_protti("combined.csv")
```

```{r}
data <- create_synthetic_data(n_proteins = 3663,
                              frac_change = 0.05,
                              n_replicates = 1,
                              n_conditions = 2,
                              method = "effect_random",
                              additional_metadata = FALSE)
```

```{r}
normalised_data <- data %>% 
  normalise(sample = sample,
            intensity_log2 = peptide_intensity_missing,
            method = "median")
```

```{r}
data_missing <- normalised_data %>% 
  assign_missingness(sample = sample,
                     condition = condition,
                     grouping = peptide,
                     intensity = normalised_intensity_log2,
                     ref_condition = "condition_1",
                     retain_columns = c(protein, change_peptide))
```

```{r}
result <- data_missing %>% 
  calculate_diff_abundance(sample = sample,
                           condition = condition,
                           grouping = peptide,
                           intensity_log2 = normalised_intensity_log2,
                           missingness = missingness,
                           comparison = comparison,
                           filter_NA_missingness = TRUE,
                           method = "moderated_t-test",
                           retain_columns = c(Protein, change_peptide))
```

```{r}
result %>% 
  volcano_plot(grouping = peptide,
                 log2FC = diff,
                 significance = pval,
                 method = "target",
                 target_column = change_peptide,
                 target = TRUE,
                 legend_label = "Ground Truth",
                 significance_cutoff = c(0.05, "adj_pval"))
```
